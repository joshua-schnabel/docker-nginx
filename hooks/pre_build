#!/bin/bash

set -e

L_SOURCE_BRANCH="${SOURCE_BRANCH}"
L_GIT_SHA1="${GIT_SHA1}"
L_VERSION=$(head -n 1 ./CHANGELOG)
L_VERSIONSUFFIX=""

echo "Building Branch $L_SOURCE_BRANCH ($L_GIT_SHA1), how lovely..."

if [[ $L_VERSION == *"-"* ]]; then
        L_VERSIONSUFFIX="-$(echo $L_VERSION| cut -d '-' -f 2)"
fi
L_MINORVERSION="${L_VERSION%.*}${L_VERSIONSUFFIX}"

L_INTVERSION=$(curl -vs https://pkgs.alpinelinux.org/package/v3.11/main/x86_64/nginx 2>&1 | grep -o -h -m 1 "[[:digit:]]\.[[:digit:]]\{1,2\}\.[[:digit:]]\{1,2\}-r[0-9]\{1,2\}")
L_INTVERSIONSUFFIX=""

if [[ $L_INTVERSION == *"-"* ]]; then
        L_INTVERSIONSUFFIX="-$(echo $L_INTVERSION | cut -d '-' -f 2)"
fi
L_INTPATCHVERSION="${L_INTVERSION%-*}"
L_INTMINORVERSION="${L_INTVERSION%.*}"

L_GITTAG="version-$L_INTVERSION-$L_VERSION"

if [ "$L_SOURCE_BRANCH" = "master" ]; then
  echo "Oh we are building master, how nice..."
  echo "This version $L_VERSION is Part of series $L_MINORVERSION"
  if git rev-parse "$L_GITTAG" >/dev/null 2>&1; then
    echo "Tag $L_GITTAG already exists";
    exit 0;
  fi
fi
